<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Log Analyzer</title>
    <!-- Base dependencies -->
    <script src="https://unpkg.com/react@17/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@17/umd/react-dom.development.js"></script>
    <!-- Load components -->
    <script src="/components/MetricsOverview.js"></script>
    <script src="/components/HttpAnalysis.js"></script>
    <script src="/components/ErrorAnalysis.js"></script>
    <script src="/components/SecurityAnalysis.js"></script>
    <script src="/components/PerformanceAnalysis.js"></script>
    <script src="/components/TimeAnalysis.js"></script>
    <script src="/components/FirewallDashboard.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
</head>
<body class="bg-gray-100">
    <div id="root"></div>

    <script>
        const App = () => {
            const [files, setFiles] = React.useState([]);
            const [loading, setLoading] = React.useState(false);
            const [results, setResults] = React.useState(null);
            const [error, setError] = React.useState(null);
            const [parser, setParser] = React.useState('');
            const [filters, setFilters] = React.useState('');
            const [logType, setLogType] = React.useState('standard'); // standard or firewall

            const handleFileChange = (e) => {
                const selectedFiles = Array.from(e.target.files);
                const validFiles = selectedFiles.filter(file => 
                    file.name.endsWith('.log') || file.name.endsWith('.txt')
                );
                
                if (validFiles.length !== selectedFiles.length) {
                    setError('Some files were invalid. Only .log and .txt files are allowed.');
                }
                
                setFiles(validFiles);
                setError(null);
            };

            const handleSubmit = async (e) => {
                e.preventDefault();
                if (files.length === 0) {
                    setError('Please select at least one log file');
                    return;
                }
                
                setLoading(true);
                setError(null);
                setResults(null);

                try {
                    const formData = new FormData();
                    files.forEach(file => {
                        formData.append('files', file);
                    });
                    if (parser) {
                        formData.append('parser', parser);
                    }
                    if (filters) {
                        formData.append('filters', filters);
                    }
                    
                    // Add log type to determine analysis mode
                    formData.append('log_type', logType);

                    const response = await fetch('/analyze', {
                        method: 'POST',
                        body: formData
                    });

                    if (!response.ok) {
                        throw new Error('Failed to start analysis');
                    }

                    const data = await response.json();
                    
                    const pollResults = async () => {
                        try {
                            const statusResponse = await fetch(`/tasks/${data.task_id}`);
                            const taskStatus = await statusResponse.json();
                            
                            if (taskStatus.status === 'completed' && taskStatus.results) {
                                console.log('Results received:', taskStatus.results);
                                setResults(taskStatus.results);
                                setLoading(false);
                            } else if (taskStatus.status === 'failed') {
                                throw new Error(taskStatus.error || 'Analysis failed');
                            } else if (taskStatus.status === 'processing') {
                                setTimeout(pollResults, 1000);
                            }
                        } catch (pollError) {
                            setError(pollError.message);
                            setLoading(false);
                        }
                    };

                    pollResults();
                } catch (err) {
                    setError(err.message);
                    setLoading(false);
                }
            };

            const renderStandardParserOptions = () => {
                return [
                    React.createElement('option', { value: '', key: 'auto' }, 'Auto-detect'),
                    React.createElement('option', { value: 'apache_access', key: 'apache-access' }, 'Apache Access Log'),
                    React.createElement('option', { value: 'apache_error', key: 'apache-error' }, 'Apache Error Log'),
                    React.createElement('option', { value: 'nginx_access', key: 'nginx-access' }, 'Nginx Access Log'),
                    React.createElement('option', { value: 'nginx_error', key: 'nginx-error' }, 'Nginx Error Log'),
                    React.createElement('option', { value: 'syslog', key: 'syslog' }, 'Syslog')
                ];
            };

            const renderFirewallParserOptions = () => {
                return [
                    React.createElement('option', { value: 'firewall', key: 'auto-firewall' }, 'Auto-detect Firewall'),
                    React.createElement('option', { value: 'iptables', key: 'iptables' }, 'IPTables'),
                    React.createElement('option', { value: 'pfsense', key: 'pfsense' }, 'pfSense'),
                    React.createElement('option', { value: 'cisco_asa', key: 'cisco-asa' }, 'Cisco ASA'),
                    React.createElement('option', { value: 'windows_firewall', key: 'windows-firewall' }, 'Windows Firewall')
                ];
            };

            const renderResults = () => {
                if (!results) return null;

                // If firewall analysis, show different components
                if (logType === 'firewall' && results.firewall_analysis) {
                    return React.createElement('div', { className: 'space-y-6' }, [
                        React.createElement(FirewallDashboard, { 
                            data: results.firewall_analysis,
                            key: 'firewall-dashboard'
                        })
                    ]);
                }

                // Standard log analysis
                return React.createElement('div', { className: 'space-y-6' }, [
                    React.createElement(MetricsOverview, { 
                        data: results.summary,
                        key: 'metrics'
                    }),
                    React.createElement(HttpAnalysis, { 
                        data: results.http_analysis,
                        key: 'http'
                    }),
                    React.createElement(ErrorAnalysis, { 
                        data: results.error_analysis,
                        key: 'error'
                    }),
                    React.createElement(SecurityAnalysis, { 
                        data: results.security_analysis,
                        key: 'security'
                    }),
                    React.createElement(PerformanceAnalysis, { 
                        data: results.performance_metrics,
                        key: 'performance'
                    }),
                    React.createElement(TimeAnalysis, { 
                        data: results.time_analysis,
                        key: 'time'
                    })
                ]);
            };

            return React.createElement('div', { className: 'container mx-auto px-4 py-8' }, [
                React.createElement('h1', { 
                    className: 'text-3xl font-bold mb-8',
                    key: 'title'
                }, 'Log Analyzer'),
                
                React.createElement('div', { 
                    className: 'bg-white rounded-lg shadow p-6 mb-8',
                    key: 'upload'
                }, [
                    React.createElement('h2', { 
                        className: 'text-xl font-semibold mb-4',
                        key: 'upload-title'
                    }, 'Analyze Logs'),
                    React.createElement('form', { 
                        onSubmit: handleSubmit,
                        className: 'space-y-4',
                        key: 'form'
                    }, [
                        // File Input Group
                        React.createElement('div', { key: 'file-group' }, [
                            React.createElement('label', { 
                                className: 'block text-sm font-medium text-gray-700 mb-2',
                                key: 'file-label'
                            }, 'Log Files'),
                            React.createElement('input', {
                                type: 'file',
                                onChange: handleFileChange,
                                multiple: true,
                                accept: '.log,.txt',
                                className: 'block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100',
                                key: 'file-input'
                            })
                        ]),

                        // Log Type Selection
                        React.createElement('div', { key: 'log-type-group' }, [
                            React.createElement('label', {
                                className: 'block text-sm font-medium text-gray-700 mb-2',
                                key: 'log-type-label'
                            }, 'Log Type'),
                            React.createElement('select', {
                                className: 'block w-full rounded-md border border-gray-300 shadow-sm p-2',
                                value: logType,
                                onChange: (e) => {
                                    setLogType(e.target.value);
                                    setParser(''); // Reset parser when log type changes
                                },
                                key: 'log-type-select'
                            }, [
                                React.createElement('option', { value: 'standard', key: 'std' }, 'Standard Logs'),
                                React.createElement('option', { value: 'firewall', key: 'fw' }, 'Firewall Logs')
                            ])
                        ]),

                        // Parser Selection Group
                        React.createElement('div', { key: 'parser-group' }, [
                            React.createElement('label', {
                                className: 'block text-sm font-medium text-gray-700 mb-2',
                                key: 'parser-label'
                            }, 'Parser'),
                            React.createElement('select', {
                                className: 'block w-full rounded-md border border-gray-300 shadow-sm p-2',
                                value: parser,
                                onChange: (e) => setParser(e.target.value),
                                key: 'parser-select'
                            }, logType === 'firewall' ? renderFirewallParserOptions() : renderStandardParserOptions())
                        ]),

                        // Filters Group
                        React.createElement('div', { key: 'filter-group' }, [
                            React.createElement('label', {
                                className: 'block text-sm font-medium text-gray-700 mb-2',
                                key: 'filter-label'
                            }, 'Filters'),
                            React.createElement('input', {
                                type: 'text',
                                placeholder: "e.g. level=='ERROR'",
                                className: 'block w-full rounded-md border border-gray-300 shadow-sm p-2',
                                value: filters,
                                onChange: (e) => setFilters(e.target.value),
                                key: 'filter-input'
                            })
                        ]),

                        // File Count and Submit Button
                        React.createElement('div', { key: 'submit-group' }, [
                            files.length > 0 && React.createElement('div', {
                                className: 'text-sm text-gray-500 mb-4',
                                key: 'file-count'
                            }, `${files.length} file(s) selected`),
                            React.createElement('button', {
                                type: 'submit',
                                disabled: loading || files.length === 0,
                                className: 'w-full py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 disabled:opacity-50',
                                key: 'submit'
                            }, loading ? 'Analyzing...' : 'Analyze Logs')
                        ])
                    ]),
                    error && React.createElement('div', {
                        className: 'mt-4 p-4 rounded-md bg-red-50 text-red-700',
                        key: 'error'
                    }, error)
                ]),
                
                loading && React.createElement('div', {
                    className: 'flex items-center justify-center p-4',
                    key: 'loading'
                }, [
                    React.createElement('div', {
                        className: 'animate-spin rounded-full h-8 w-8 border-b-2 border-blue-500',
                        key: 'spinner'
                    }),
                    React.createElement('span', {
                        className: 'ml-2 text-blue-700',
                        key: 'loading-text'
                    }, 'Processing logs...')
                ]),
                
                renderResults()
            ]);
        };

        // Simple FirewallMetricsOverview component
        const FirewallMetricsOverview = ({ data }) => {
            return React.createElement('div', { 
                className: 'grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4'
            }, [
                React.createElement('div', {
                    className: 'bg-blue-50 border border-blue-100 rounded-lg p-4',
                    key: 'total'
                }, [
                    React.createElement('div', {
                        className: 'text-sm text-blue-600 font-medium',
                        key: 'title'
                    }, 'TOTAL ENTRIES'),
                    React.createElement('div', {
                        className: 'text-2xl font-bold mt-1',
                        key: 'value'
                    }, data.total_entries.toLocaleString())
                ]),
                
                React.createElement('div', {
                    className: 'bg-green-50 border border-green-100 rounded-lg p-4',
                    key: 'allowed'
                }, [
                    React.createElement('div', {
                        className: 'text-sm text-green-600 font-medium',
                        key: 'title'
                    }, 'ALLOWED CONNECTIONS'),
                    React.createElement('div', {
                        className: 'text-2xl font-bold mt-1',
                        key: 'value'
                    }, data.allowed_connections.toLocaleString())
                ]),
                
                React.createElement('div', {
                    className: 'bg-red-50 border border-red-100 rounded-lg p-4',
                    key: 'blocked'
                }, [
                    React.createElement('div', {
                        className: 'text-sm text-red-600 font-medium',
                        key: 'title'
                    }, 'BLOCKED CONNECTIONS'),
                    React.createElement('div', {
                        className: 'text-2xl font-bold mt-1',
                        key: 'value'
                    }, data.blocked_connections.toLocaleString()),
                    React.createElement('div', {
                        className: 'text-sm text-gray-500',
                        key: 'percent'
                    }, `${data.blocked_percentage}% of all traffic`)
                ]),
                
                React.createElement('div', {
                    className: 'bg-yellow-50 border border-yellow-100 rounded-lg p-4',
                    key: 'ips'
                }, [
                    React.createElement('div', {
                        className: 'text-sm text-yellow-600 font-medium',
                        key: 'title'
                    }, 'UNIQUE IPs'),
                    React.createElement('div', {
                        className: 'text-2xl font-bold mt-1',
                        key: 'value'
                    }, data.unique_ips.toLocaleString())
                ])
            ]);
        };

        // Simple FirewallSecurityAnalysis component
        const FirewallSecurityAnalysis = ({ data }) => {
            return React.createElement('div', { className: 'space-y-6'}, [
                React.createElement('div', {
                    className: 'bg-white rounded-lg shadow p-6',
                    key: 'ports'
                }, [
                    React.createElement('h3', {
                        className: 'text-lg font-semibold mb-4',
                        key: 'title'
                    }, 'Top Blocked Ports'),
                    
                    React.createElement('div', {
                        className: 'grid grid-cols-1 md:grid-cols-2 gap-6',
                        key: 'content'
                    }, [
                        React.createElement('table', {
                            className: 'min-w-full divide-y divide-gray-200',
                            key: 'table'
                        }, [
                            React.createElement('thead', {
                                className: 'bg-gray-50',
                                key: 'thead'
                            }, [
                                React.createElement('tr', { key: 'header-row' }, [
                                    React.createElement('th', {
                                        scope: 'col',
                                        className: 'px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider',
                                        key: 'port-header'
                                    }, 'Port'),
                                    React.createElement('th', {
                                        scope: 'col',
                                        className: 'px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider',
                                        key: 'service-header'
                                    }, 'Service'),
                                    React.createElement('th', {
                                        scope: 'col',
                                        className: 'px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider',
                                        key: 'count-header'
                                    }, 'Count')
                                ])
                            ]),
                            React.createElement('tbody', {
                                className: 'bg-white divide-y divide-gray-200',
                                key: 'tbody'
                            }, data.top_blocked_ports.map((item, index) => 
                                React.createElement('tr', { key: `port-${index}` }, [
                                    React.createElement('td', {
                                        className: 'px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900',
                                        key: 'port'
                                    }, item.port),
                                    React.createElement('td', {
                                        className: 'px-6 py-4 whitespace-nowrap text-sm text-gray-500',
                                        key: 'service'
                                    }, item.service),
                                    React.createElement('td', {
                                        className: 'px-6 py-4 whitespace-nowrap text-sm text-gray-500',
                                        key: 'count'
                                    }, item.count)
                                ])
                            ))
                        ])
                    ])
                ]),

                React.createElement('div', {
                    className: 'bg-white rounded-lg shadow p-6',
                    key: 'ips'
                }, [
                    React.createElement('h3', {
                        className: 'text-lg font-semibold mb-4',
                        key: 'title'
                    }, 'Top Blocked IPs'),
                    
                    React.createElement('div', {
                        className: 'grid grid-cols-1 md:grid-cols-2 gap-6',
                        key: 'content'
                    }, [
                        React.createElement('table', {
                            className: 'min-w-full divide-y divide-gray-200',
                            key: 'table'
                        }, [
                            React.createElement('thead', {
                                className: 'bg-gray-50',
                                key: 'thead'
                            }, [
                                React.createElement('tr', { key: 'header-row' }, [
                                    React.createElement('th', {
                                        scope: 'col',
                                        className: 'px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider',
                                        key: 'ip-header'
                                    }, 'IP Address'),
                                    React.createElement('th', {
                                        scope: 'col',
                                        className: 'px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider',
                                        key: 'count-header'
                                    }, 'Block Count')
                                ])
                            ]),
                            React.createElement('tbody', {
                                className: 'bg-white divide-y divide-gray-200',
                                key: 'tbody'
                            }, data.top_blocked_ips.map((item, index) => 
                                React.createElement('tr', { key: `ip-${index}` }, [
                                    React.createElement('td', {
                                        className: 'px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900',
                                        key: 'ip'
                                    }, item.ip),
                                    React.createElement('td', {
                                        className: 'px-6 py-4 whitespace-nowrap text-sm text-gray-500',
                                        key: 'count'
                                    }, item.count)
                                ])
                            ))
                        ])
                    ])
                ])
            ]);
        };

        // Mount the app
        ReactDOM.render(
            React.createElement(App),
            document.getElementById('root')
        );
    </script>
</body>
</html>